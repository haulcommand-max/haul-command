name: Main Release

on:
  push:
    branches: [main]

concurrency:
  group: main-release
  cancel-in-progress: true

env:
  # Flip to "true" after first clean Lighthouse run
  ENFORCE_LIGHTHOUSE: "false"

jobs:
  ci:
    name: Full CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci --legacy-peer-deps
      - run: npm run lint
      - run: npm run typecheck
      - run: npm test --if-present
      - run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  deploy_prod:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: [ci]
    outputs:
      prod_url: ${{ steps.deploy.outputs.prod_url }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci --legacy-peer-deps
      - run: npm i -g vercel

      - name: Pull Vercel Env (Production)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel pull --yes --environment=production --token=$VERCEL_TOKEN

      - name: Build (Vercel)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: vercel build --prod --token=$VERCEL_TOKEN

      - name: Deploy (Production)
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          url=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          echo "prod_url=$url" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployed to: $url"

      - name: Notify deploy success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          node scripts/ops/notify.mjs \
            --status=success \
            --title="Production Deploy Complete" \
            --url="${{ steps.deploy.outputs.prod_url }}" \
            --details="SHA: ${{ github.sha }}"

      - name: Notify deploy failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          node scripts/ops/notify.mjs \
            --status=fail \
            --title="Production Deploy FAILED" \
            --details="Check workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  lighthouse_gate:
    name: Lighthouse Quality Gate
    runs-on: ubuntu-latest
    needs: [deploy_prod]
    steps:
      - uses: actions/checkout@v4

      - name: Run Lighthouse CI with budgets
        id: lhci
        run: |
          npm i -g @lhci/cli
          echo "Auditing ${{ needs.deploy_prod.outputs.prod_url }}"

          # Determine assert level based on enforcement flag
          ASSERT_LEVEL="warn"
          if [ "${{ env.ENFORCE_LIGHTHOUSE }}" = "true" ]; then
            ASSERT_LEVEL="error"
          fi

          lhci autorun \
            --collect.url="${{ needs.deploy_prod.outputs.prod_url }}" \
            --collect.url="${{ needs.deploy_prod.outputs.prod_url }}/directory" \
            --collect.url="${{ needs.deploy_prod.outputs.prod_url }}/map" \
            --assert.budgetsFile="lighthouse/budgets.json" \
            --assert.assertions.categories:performance=$ASSERT_LEVEL \
            --assert.assertions.categories:accessibility=$ASSERT_LEVEL \
            --assert.assertions.categories:best-practices=$ASSERT_LEVEL \
            --assert.assertions.categories:seo=$ASSERT_LEVEL \
            2>&1 | tee /tmp/lhci-output.txt || true

          # Parse scores for notification
          echo "lhci_output<<EOF" >> $GITHUB_OUTPUT
          tail -20 /tmp/lhci-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Lighthouse results
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          node scripts/ops/notify.mjs \
            --status=${{ steps.lhci.outcome == 'success' && 'success' || 'warn' }} \
            --title="Lighthouse Quality Gate" \
            --details="Enforce mode: ${{ env.ENFORCE_LIGHTHOUSE }}. See workflow for scores."

  notify:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [deploy_prod, lighthouse_gate]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Post release summary
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          DEPLOY_STATUS="${{ needs.deploy_prod.result }}"
          LHCI_STATUS="${{ needs.lighthouse_gate.result }}"

          if [ "$DEPLOY_STATUS" = "success" ] && [ "$LHCI_STATUS" = "success" ]; then
            STATUS="success"
          else
            STATUS="warn"
          fi

          node scripts/ops/notify.mjs \
            --status=$STATUS \
            --title="Release Summary: deploy=$DEPLOY_STATUS lighthouse=$LHCI_STATUS" \
            --url="${{ needs.deploy_prod.outputs.prod_url }}" \
            --details="SHA: ${{ github.sha }} | Branch: ${{ github.ref_name }}"
