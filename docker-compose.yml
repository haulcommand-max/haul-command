version: '3.8'

services:
  # ----------------------------------------------------
  # 1. CORE DATA LAYER
  # ----------------------------------------------------
  postgres:
    image: postgis/postgis:15-3.4
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-haul_command}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # ----------------------------------------------------
  # 3. SEARCH & DISCOVERY
  # ----------------------------------------------------
  typesense:
    image: typesense/typesense:29.0
    ports:
      - "8108:8108"
    volumes:
      - typesense-data:/data
    environment:
      TYPESENSE_DATA_DIR: /data
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY:-dev_typesense_key_123}
      TYPESENSE_ENABLE_CORS: "true"
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8108/health" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------
  # 17. BILLING & MONETIZATION (LAGO)
  # ----------------------------------------------------
  lago-api:
    image: getlago/api:latest
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY}
      RAILS_ENV: development
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-haul_command}
      REDIS_URL: redis://redis:6379/0
      LAGO_API_URL: http://localhost:3000
      STRIPE_API_KEY: ${STRIPE_API_KEY:-""}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-dev_secret_key_123}

  lago-front:
    image: getlago/front:latest
    ports:
      - "8080:80"
    depends_on:
      - lago-api
    environment:
      API_URL: http://localhost:3000

  # ----------------------------------------------------
  # EMAIL: LISTMONK (campaign engine + admin UI)
  # ----------------------------------------------------
  listmonk-db:
    image: postgres:16-alpine
    container_name: hc-listmonk-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: listmonk
      POSTGRES_USER: listmonk
      POSTGRES_PASSWORD: ${LISTMONK_DB_PASSWORD:-listmonk_dev_password}
    ports:
      - "5433:5432"
    volumes:
      - listmonk-db-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U listmonk" ]
      interval: 5s
      timeout: 5s
      retries: 5

  listmonk-app:
    image: listmonk/listmonk:latest
    container_name: hc-listmonk-app
    restart: unless-stopped
    depends_on:
      listmonk-db:
        condition: service_healthy
    ports:
      - "9000:9000"
    environment:
      - LISTMONK_db__host=listmonk-db
      - LISTMONK_db__port=5432
      - LISTMONK_db__user=listmonk
      - LISTMONK_db__password=${LISTMONK_DB_PASSWORD:-listmonk_dev_password}
      - LISTMONK_db__database=listmonk
      - LISTMONK_app__address=0.0.0.0:9000
      - LISTMONK_app__admin_username=${LISTMONK_ADMIN_USERNAME:-admin}
      - LISTMONK_app__admin_password=${LISTMONK_ADMIN_PASSWORD:-hc_listmonk_admin}

  listmonk:
    image: listmonk/listmonk:latest
    container_name: hc-listmonk
    depends_on:
      listmonk-db:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      LISTMONK_app__address: "0.0.0.0:9000"
      LISTMONK_db__host: "listmonk-db"
      LISTMONK_db__port: "5432"
      LISTMONK_db__user: "listmonk"
      LISTMONK_db__password: ${LISTMONK_DB_PASSWORD:-listmonk_dev_password}
      LISTMONK_db__database: "listmonk"
      LISTMONK_db__ssl_mode: "disable"
      LISTMONK_smtp__enabled: "false"
    # First run: docker exec -it hc-listmonk ./listmonk --install --idempotent --yes

volumes:
  postgres-data:
  redis-data:
  typesense-data:
  listmonk-db-data:
